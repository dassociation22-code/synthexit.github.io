name: Jekyll site CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Build the site in the jekyll/builder container
      run: |
        docker run \
        -v ${{ github.workspace }}:/srv/jekyll -v ${{ github.workspace }}/_site:/srv/jekyll/_site \
        jekyll/builder:latest /bin/bash -c "chmod -R 777 /srv/jekyll && jekyll build --future"

name: SYNTHEXIT OPS Router

on:
repository_dispatch:
types: [synthexit_ops]
workflow_dispatch:
inputs:
payload:
description: “JSON payload for SYNTHEXIT OPS”
required: true
type: string

permissions:
issues: write
contents: read

jobs:
route:
runs-on: ubuntu-latest
steps:
- name: Parse and Route SYNTHEXIT OPS Payload
uses: actions/github-script@v7
with:
script: |
// ────────────────────────────────────────────
// SYNTHEXIT OPS ROUTER
// The IT in I.T. — Precision. Intent. Timing. Integration.
// ────────────────────────────────────────────

```
        // ── Payload Resolution ──
        // repository_dispatch = Make pipeline (client_payload)
        // workflow_dispatch   = Manual test (inputs.payload)
        let payload;
        if (context.payload.client_payload) {
          payload = context.payload.client_payload;
        } else if (context.payload.inputs && context.payload.inputs.payload) {
          payload = JSON.parse(context.payload.inputs.payload);
        } else {
          core.setFailed('SYNTHEXIT OPS: No payload detected. Aborting.');
          process.exit(1);
        }

        console.log('── SYNTHEXIT OPS ACTIVATED ──');
        console.log('Route:    ', payload.route);
        console.log('Priority: ', payload.priority);
        console.log('Title:    ', payload.issue_title);

        // ── Security Gate ──
        // Catches tokens, PATs, and SSNs before they hit a public Issue
        const sanitize = (str) => {
          if (!str || typeof str !== 'string') return str;
          return str
            .replace(/github_pat_[A-Za-z0-9_-]*/g, '[REDACTED-TOKEN]')
            .replace(/ghp_[A-Za-z0-9]*/g, '[REDACTED-TOKEN]')
            .replace(/gho_[A-Za-z0-9]*/g, '[REDACTED-TOKEN]')
            .replace(/\b\d{3}-\d{2}-\d{4}\b/g, '[REDACTED-SSN]');
        };

        const title = sanitize(payload.issue_title) || 'SYNTHEXIT — Untitled Event';
        const body  = sanitize(payload.issue_body_markdown) || 'No body content provided.';
        let labels  = payload.labels || [];

        // ── Priority Label Injection ──
        if (payload.priority && !labels.includes(payload.priority)) {
          labels.push(payload.priority);
        }

        // ── Label Color Map ──
        const labelColors = {
          'handshake':  '7c3aed',
          'evidence':   'e11d48',
          'timeline':   '0891b2',
          'legal':      '1d4ed8',
          'automation': '16a34a',
          'drive':      'f59e0b',
          'gmail':      'dc2626',
          'urgent':     'ff0000',
          'P0':         'dc2626',
          'P1':         'f97316',
          'P2':         'eab308',
          'P3':         '22c55e'
        };

        // ── Ensure Labels Exist in Repo ──
        const { owner, repo } = context.repo;
        for (const label of labels) {
          try {
            await github.rest.issues.createLabel({
              owner, repo,
              name: label,
              color: labelColors[label] || '888888'
            });
          } catch (e) {
            // Label already exists — no action needed
          }
        }

        // ── Repo Target ──
        const repoFull = payload.repo || `${owner}/${repo}`;
        const [targetOwner, targetRepo] = repoFull.split('/');

        // ── Route Decision ──
        if (payload.route === 'comment_issue' && payload.issue_number) {
          // ── COMMENT on existing Issue ──
          const comment = await github.rest.issues.createComment({
            owner: targetOwner,
            repo:  targetRepo,
            issue_number: Number(payload.issue_number),
            body: body
          });
          console.log(`✓ SYNTHEXIT OPS: Commented on Issue #${payload.issue_number}`);
          console.log('URL:', comment.data.html_url);

        } else {
          // ── CREATE new Issue ──
          // Enforces 90 char title limit per OPS schema
          const issue = await github.rest.issues.create({
            owner: targetOwner,
            repo:  targetRepo,
            title: title.substring(0, 90),
            body:  body,
            labels: labels
          });
          console.log(`✓ SYNTHEXIT OPS: Created Issue #${issue.data.number}`);
          console.log('Title:', title);
          console.log('URL:', issue.data.html_url);
        }
```